//ON LOAD
//Reset calobration

//modal temp
script(type='text/javascript').
    if (sessionStorage.getItem('callib_modal') !== 'true') {
        $(window).load(function () {
            socket.emit('status', 0);
            socket.emit('line_length', 0);
            socket.emit('interia', 0);
            socket.emit('status', 0);
            socket.emit('status', 3);
            socket.emit('status', 0);
            $('#calibration_modal_1').modal('show');
        });
    }

//Exit Event
script.
   window.onbeforeunload = function (e) {
      var e = e || window.event;
      // For IE and Firefox prior to version 4
      if (e) {
         e.returnValue = 'Czy na pewno chcesz opuścic tryb treningu ?';
      }
      // For Safari
      return 'Czy na pewno chcesz opuścic tryb treningu ?';
   };

//Mod invite calib
script.
    function calib_mod2_line(data) {
        $('#calibration_modal_2').modal('show')
        socket.emit('status', data);
        socket.emit('line_length',0);
        socket.emit('interia', 0);
    };



//LINE LENGTH
//Line length button --> In range chagnes check in modals code
script.
    function cal_mod_checkLI() {
        if ((document.getElementById("line_length").value >= 20 && document.getElementById("line_length").value <= 150) && (document.getElementById("interia_moment").value >= 200 && document.getElementById("interia_moment").value <= 100000) && (document.getElementById("roller_dist").value >= 10 && document.getElementById("roller_dist").value <= 40)){
            document.getElementById("btn_llength_conf").disabled = false;
        }
        else {
            document.getElementById("btn_llength_conf").disabled = true;
        }};

//Line buton confirm
script.
    function calib_mod3_line_interia(){
        socket.emit('line_length', document.getElementById("line_length").value);
        socket.emit('roller_dist', document.getElementById("roller_dist").value);
        socket.emit('interia', document.getElementById("interia_moment").value);
        document.getElementById("btn_llength_next").disabled = false;
    }

//Line Next
script.
    function calib_mod3_next(data) {
        socket.emit('status', data);
        $('#calibration_modal_3').modal('show');
    }
//Line fold
script.
    function line_fold(data){
        socket.emit('status', 4);
        socket.emit('status', data);
        $('#modal_waiting').modal('show');
        setTimeout(function () {
            $('#modal_waiting').modal('hide');
            document.getElementById("line_fold").disabled = true;
            document.getElementById("cal_mod_conf_last").disabled = false;
            document.getElementById("cal_mod_conf_last").click();
        }, 7000);
        phase_count = 0;
    }


//Calibration last
script.
    function calib_session_last(data) {
        socket.emit('status', data);
        //sessionStorage.setItem('callib_modal', 'true')
    };

//Stopwatch start button
script.
    function stopwatch_start() {
        document.getElementById("stopwatch_start").disabled = true;
        socket.emit('stopwach', 0)
    }

//RECORD DATA START
script.
    function REC_data_start(){
        socket.emit('file_name', document.getElementById("file_name_mod").value);
        socket.emit('folder_name', document.getElementById("folder_name_mod").value);
        socket.emit('REC', 1);
        document.getElementById("rec_glyph_color").style.color = "red";
        document.getElementById("rec_text_color").style.color = "red";
    };

//Stopwatch stop button
script.
    function stopwatch_stop() {
        socket.emit('REC', 0);
        socket.emit('stopwach', 1)
        document.getElementById("rec_glyph_color").style.color = "black";
        document.getElementById("rec_text_color").style.color = "black";
        document.getElementById("stopwatch_start").disabled = false;
    }

//Stopwatch end time
script.
    socket.on("stoper_stop", function () {
        document.getElementById("rec_glyph_color").style.color = "black";
        document.getElementById("rec_text_color").style.color = "black";
        document.getElementById("stopwatch_start").disabled = false;
    })

//Stopwatch update
script.
    socket.on('stoper_time', function (data) {
        seconds = data.seconds;
        minutes = data.minutes;

        if (minutes < 10 && seconds < 10) {
            document.getElementById("time_count_s").innerHTML = "0" + minutes + ":0" + seconds;
        }
        else if (minutes < 10 && seconds >= 10) {
            document.getElementById("time_count_s").innerHTML = "0" + minutes + ":" + seconds;
        }
        else if (minutes >= 10 && seconds < 10) {
            document.getElementById("time_count_s").innerHTML = minutes + ":0" + seconds;
        }
        else {
            document.getElementById("time_count_s").innerHTML = minutes + ":" + seconds;
        }
    });



//Phase triangle
script.
    socket.on('phase_sens', function (data) {
        if (data == 1) {
            document.getElementById("triangle_phase").className = "glyphicon phase glyphicon-triangle-top";
        }
        else{
            document.getElementById("triangle_phase").className = "glyphicon phase glyphicon-triangle-bottom";
        }
    });

//LINE FOLD SOCKET
script.
    socket.on('induct_stat', function (data) {
        if (data == 0) {
            document.getElementById("linaok").className = "bg-success";
            document.getElementById("fold_mod_head").className = "modal-header bg-success";
            document.getElementById("warning_fold_mod").className = "modal-header bg-success";
            document.getElementById("linaok").innerHTML = "LINA USTAWIONA OK";
            document.getElementById("line_fold").disabled = false;
            document.getElementById("fold_confirm").disabled = false;
            document.getElementById("fold_confirm").className = "btn btn-lg btn-success";

        } else{
            document.getElementById("linaok").className = "bg-danger";
            document.getElementById("fold_mod_head").className = "modal-header bg-danger";
            document.getElementById("warning_fold_mod").className = "modal-header bg-danger";
            document.getElementById("linaok").innerHTML = "LINA ZLE WYCIAGNIETA";
            document.getElementById("line_fold").disabled = true;
            document.getElementById("fold_confirm").disabled = true;
            document.getElementById("fold_confirm").className = "btn btn-lg btn-danger";
        }
    });

//Position Read
script.
    var phase_count = 0;
    var phase_past = 0;
    socket.on('phase_sens', function (data) {
        if (data==0 && phase_past==1) {
            document.getElementById("cycle_count").innerHTML = phase_count;
            phase_count  = phase_count + 1;
        }
        phase_past=data;
    });



//STOP AW
script.
    var stop_flag = 0;
    socket.on('stop_RED', function (data) {
        if (data == 0 && stop_flag == 0) {
            alert("STOP Awaryjny  - Wyłącz Stop i odśwież stronę");
            stop_flag = 1}
        if (data == 1 && stop_flag == 1) {
            stop_flag = 0
        }
    });

//ADD IN SECOND STEP

//DISPLAY BAR
script.
    socket.on('disp_bar', function (data) {
    document.getElementById("display_1").innerHTML = data;
    });

//BAR WIDTH
script.
    socket.on('procent', function (data) {
        //$('#bar1').attr({"data-transitiongoal": data.data1,"aria-valuemin": data.data2 ,"aria-valuemax": data.data3}).progressbar({display_text: 'fill', transition_delay: 0, refresh_speed: 0});

        var lower_bound = data.data2  * 0.3;
        var uppper_bound = data.data3 * 1.3;


        var procent = (data.data1-lower_bound)/(uppper_bound - lower_bound)*100;

        if (procent>=30 && procent<=70){
            $('#bar1').attr({"data-transitiongoal": data.data1,"aria-valuemin": lower_bound ,"aria-valuemax":uppper_bound, "style": "background-color: green"}).progressbar({display_text: 'fill', transition_delay: 0, refresh_speed: 0});
            $('#bar_warn_UPL').attr("style", "");
            $('#bar_warn_UPR').attr("style", "");
            $('#bar_ok_UP').attr("style","background-color: green");
            $('#bar_ok_DOWN').attr("style","background-color: green");
            $('#bar_warn_DOWNL').attr("style", "");
            $('#bar_warn_DOWNR').attr("style", "");}
        if (procent<30){
            $('#bar1').attr({"data-transitiongoal": data.data1,"aria-valuemin": lower_bound ,"aria-valuemax":uppper_bound, "style": "background-color: red"}).progressbar({display_text: 'fill', transition_delay: 0, refresh_speed: 0});
            $('#bar_warn_UPL').attr("style", "background-color: red");
            $('#bar_warn_UPR').attr("style", "");
            $('#bar_ok_UP').attr("style","");
            $('#bar_ok_DOWN').attr("style","");
            $('#bar_warn_DOWNL').attr("style","background-color: red");
            $('#bar_warn_DOWNR').attr("style","");}
        if (procent>70){
            $('#bar1').attr({"data-transitiongoal": data.data1,"aria-valuemin": lower_bound ,"aria-valuemax":uppper_bound, "style": "background-color: red"}).progressbar({display_text: 'fill', transition_delay: 0, refresh_speed: 0});            $('#bar_warn_UPL').attr("style","");
            $('#bar_warn_UPR').attr("style","background-color: red");
            $('#bar_ok_UP').attr("style","");
            $('#bar_ok_DOWN').attr("style","");
            $('#bar_warn_DOWNL').attr("style", "");
            $('#bar_warn_DOWNR').attr("style", "background-color: red");}
        else {
            $('#bar1').attr({"data-transitiongoal": data.data1,"aria-valuemin": lower_bound ,"aria-valuemax":uppper_bound}).progressbar({display_text: 'fill', transition_delay: 0, refresh_speed: 0});
        }
    });

//DISP SELECTED
script.
    function bar_selected(){
        var selectedValue = $('#disp1_sel').find("option:selected").attr("id");
        socket.emit("sel_disp_1", selectedValue);
    }
